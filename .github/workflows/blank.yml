name: helm-to-k8s-demo

on:
  workflow_dispatch:
  push:
    branches: [main, master]

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/devops-training-demo
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./src
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=registry,ref=${{ env.IMAGE_NAME }}:latest
          cache-to: type=inline

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/v1.34.0/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/kubectl
          kubectl version --client

      - name: Install Helm
        run: |
          curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          helm version

      - name: Install kind
        run: |
          curl -Lo kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64
          chmod +x kind
          sudo mv kind /usr/local/bin/kind
          kind version

      - name: Create cluster
        run: |
          kind create cluster --name ci
          kubectl get nodes

      - name: Deploy chart with custom image
        run: |
          kubectl create ns demo
          helm upgrade --install demo ./charts/demo \
            --set image.repository=${{ secrets.DOCKERHUB_USERNAME }}/devops-training-demo \
            --set image.tag=${{ github.sha }} \
            --set image.pullPolicy=Always \
            -n demo
          kubectl get all -n demo

      - name: Wait for deployment
        run: |
          kubectl rollout status deploy/demo-hello-web -n demo --timeout=180s

      - name: Smoke test (port-forward + curl)
        run: |
          kubectl -n demo port-forward svc/demo-hello-web 8080:80 >/tmp/pf.log 2>&1 &
          sleep 5
          curl -v http://127.0.0.1:8080/
          echo "=== Deployment successful! ==="
